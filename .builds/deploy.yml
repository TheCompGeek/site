image: archlinux
packages:
  - nodejs
  - pnpm
sources:
  - https://git.sr.ht/~boehs/site
secrets:
  - c67d26a1-1f66-4f3c-b7b0-75d118eee7b7
tasks:
  - setup: |
      cd site/html
      pnpm install --frozen-lockfile
  - build: |
      cd site/html
      {
        set +x
        . ~/.buildsecrets
        set -x
      }
      export NETLIFY_AUTH_TOKEN
      pnpm exec netlify build
  - deploy: |
      cd site/html
      {
        set +x
        . ~/.buildsecrets
        set -x
      }
      export NETLIFY_AUTH_TOKEN
      pnpm exec netlify deploy --prod
  - artifact: |
      cd site/html/dist
      tar -cvz . > ../site.tar.gz
artifacts:
  - site/html/site.tar.gz
